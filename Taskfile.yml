version: '3'

env:
  PROCS:
    sh: nproc
  GOMAXPROCS: 1
#  GOSUMDB: off
#  GOPROXY: direct

tasks:
  runall:
    desc: Run a command in all packages
    cmds:
      - find . -mindepth 2 -name 'go.mod' -print0 | xargs -0 -n1 -P ${PROCS} -- /bin/bash -c 'pushd `dirname $1`; {{.CLI_ARGS}}; popd >/dev/null' '_'

  run:
    desc: Run a command in a directory
    cmds:
      - pushd {{index (splitArgs .CLI_ARGS) 0}}; {{index (splitArgs .CLI_ARGS) 1}}; popd >/dev/null
    vars:
      DIRECTORY: splitArgs

###########################
# Runall helpers
###########################
  tidy:
    desc: Run "go mod tidy -go=1.20" in all packages
    cmds:
      - task: runall
        vars:
          CLI_ARGS: go mod tidy -go=1.20
  fmt:
    desc: Run "go fmt" in all packages
    cmds:
      - task: runall
        vars:
          CLI_ARGS: go fmt

  update:
    desc: Run "go get -u ./..." in all packages
    cmds:
      - task: runall
        vars:
          CLI_ARGS: go get -u ./...
  test:
    desc: Run "go test ./..." in all packages
    cmds:
      - task: runall
        vars:
          CLI_ARGS: go test ./...

###########################
# Others
###########################
  check:
    desc: Run "trunk check -a" in all projects
    cmds:
      - pushd go-orb; trunk check -a || true ; popd >/dev/null
      - pushd plugins; trunk check -a || true ; popd >/dev/null
      # - pushd quick; trunk check -a || true ; popd >/dev/null